<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Administrar Comentarios</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="container py-4">
    <h2>Administrar Comentarios</h2>

    <form method="get" class="my-3">
        <div class="row g-3 mb-2">
            <div class="col-md-4">
                <label for="nombre" class="form-label">Nombre a buscar</label>
                <input type="text" name="nombre" id="nombre" class="form-control" placeholder="Buscar por nombre" value="{{ nombre_filtro }}">
            </div>
            <div class="col-md-4">
                <label for="fecha_inicio" class="form-label">Fecha inicio</label>
                <input type="date" name="fecha_inicio" id="fecha_inicio" class="form-control" value="{{ fecha_inicio }}">
            </div>
            <div class="col-md-4">
                <label for="fecha_fin" class="form-label">Fecha fin</label>
                <input type="date" name="fecha_fin" id="fecha_fin" class="form-control" value="{{ fecha_fin }}">
            </div>
        </div>

        <div class="row g-3">
            <div class="col-md-4">
                <label for="sector" class="form-label">Sector</label>
                <select name="sector" id="sector" class="form-select">
                    <option value="">Todos los sectores</option>
                    {% for sector in sectores %}
                        <option value="{{ sector }}" {% if sector == sector_filtro %}selected{% endif %}>{{ sector|capfirst }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2 align-self-end">
                <button class="btn btn-secondary w-100">Filtrar</button>
            </div>
        </div>
    </form>

    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card text-white bg-primary mb-3">
                <div class="card-body">
                    <h5 class="card-title">Amabilidad</h5>
                    <p class="card-text fs-4">{{ promedios.amabilidad_avg|floatformat:1 }} ★</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-white bg-success mb-3">
                <div class="card-body">
                    <h5 class="card-title">Eficiencia</h5>
                    <p class="card-text fs-4">{{ promedios.eficiencia_avg|floatformat:1 }} ★</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-white bg-warning mb-3">
                <div class="card-body">
                    <h5 class="card-title">Limpieza</h5>
                    <p class="card-text fs-4">{{ promedios.limpieza_avg|floatformat:1 }} ★</p>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6 mb-4">
            <div class="card p-3">
                <h5 class="card-title">¿Recordás quién te atendió?</h5>
                <canvas id="recordasChart"></canvas>
            </div>
        </div>
        <div class="col-md-6 mb-4">
            <div class="card p-3">
                <h5 class="card-title">¿Cómo nos conociste?</h5>
                <canvas id="conocisteChart"></canvas>
            </div>
        </div>
    </div>

    <h4 class="mt-5">Comentarios</h4>

    <table class="table table-bordered">
        <thead>
            <tr>
                <th>Nombre</th>
                <th>Teléfono</th>
                <th>Amabilidad</th>
                <th>Eficiencia</th>
                <th>Limpieza</th>
                <th>Comentario</th>
                <th>Sector</th>
                <th>Atendido por</th>
                <th>Fecha</th>
            </tr>
        </thead>
        <tbody>
            {% for c in page_obj %}
            <tr>
                <td>{% if c.nombre %}{{ c.nombre|capfirst }}{% else %}-{% endif %}</td>  <!-- Si no tiene nombre, muestra - y capitaliza la primera letra -->
                <td>{% if c.telefono %}{{ c.telefono }}{% else %}-{% endif %}</td>  <!-- Si no tiene teléfono, muestra - -->
                <td>{{ c.amabilidad }}</td>
                <td>{{ c.eficiencia }}</td>
                <td>{{ c.limpieza }}</td>
                <td>{% if c.destacado %}{{ c.destacado }}{% else %}S/C{% endif %}</td>
                <td>{% if c.sector %}{{ c.sector|capfirst }}{% else %}-{% endif %}</td>  <!-- Si no tiene sector, muestra - y capitaliza la primera letra -->
                <td>{% if c.recordas_quien %}{{ c.recordas_quien|capfirst }}{% else %}-{% endif %}</td>  <!-- Si no tiene quien atendió, muestra - y capitaliza la primera letra -->
                <td>{{ c.fecha }}</td>
            </tr>
            {% empty %}
            <tr><td colspan="9">No hay comentarios en este rango</td></tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- PAGINACION -->
    {% if page_obj.has_other_pages %}
    <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center">
            {% if page_obj.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?{% if nombre_filtro %}nombre={{ nombre_filtro }}&{% endif %}{% if fecha_inicio %}fecha_inicio={{ fecha_inicio }}&{% endif %}{% if fecha_fin %}fecha_fin={{ fecha_fin }}&{% endif %}{% if sector_filtro %}sector={{ sector_filtro }}&{% endif %}page={{ page_obj.previous_page_number }}">Anterior</a>
            </li>
            {% else %}
            <li class="page-item disabled"><span class="page-link">Anterior</span></li>
            {% endif %}

            {% for num in page_obj.paginator.page_range %}
                {% if page_obj.number == num %}
                    <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                    <li class="page-item"><a class="page-link" href="?{% if nombre_filtro %}nombre={{ nombre_filtro }}&{% endif %}{% if fecha_inicio %}fecha_inicio={{ fecha_inicio }}&{% endif %}{% if fecha_fin %}fecha_fin={{ fecha_fin }}&{% endif %}{% if sector_filtro %}sector={{ sector_filtro }}&{% endif %}page={{ num }}">{{ num }}</a></li>
                {% endif %}
            {% endfor %}

            {% if page_obj.has_next %}
            <li class="page-item">
                <a class="page-link" href="?{% if nombre_filtro %}nombre={{ nombre_filtro }}&{% endif %}{% if fecha_inicio %}fecha_inicio={{ fecha_inicio }}&{% endif %}{% if fecha_fin %}fecha_fin={{ fecha_fin }}&{% endif %}{% if sector_filtro %}sector={{ sector_filtro }}&{% endif %}page={{ page_obj.next_page_number }}">Siguiente</a>
            </li>
            {% else %}
            <li class="page-item disabled"><span class="page-link">Siguiente</span></li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}

    {{ recordas_quien_hist|json_script:"recordas-data" }}
    {{ como_conociste_hist|json_script:"conociste-data" }}

    <script>
        const recordasRaw = JSON.parse(document.getElementById('recordas-data').textContent);
        const conocisteRaw = JSON.parse(document.getElementById('conociste-data').textContent);
    
        const capitalizeFirstLetter = (str) => {
            if (!str) return str;
            return str.charAt(0).toUpperCase() + str.slice(1).toLowerCase();
        };
    
        const recordasLabels = recordasRaw.map(item => capitalizeFirstLetter(item.recordas_quien || 'Sin respuesta'));
        const recordasData = recordasRaw.map(item => item.count);
    
        const conocisteLabels = conocisteRaw.map(item => capitalizeFirstLetter(item.como_conociste || 'Sin respuesta'));
        const conocisteData = conocisteRaw.map(item => item.count);
    
        new Chart(document.getElementById('recordasChart'), {
            type: 'bar',
            data: {
                labels: recordasLabels,
                datasets: [{
                    label: 'Cantidad',
                    data: recordasData,
                    backgroundColor: '#0d6efd'
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: false }
                }
            }
        });
    
        new Chart(document.getElementById('conocisteChart'), {
            type: 'bar',
            data: {
                labels: conocisteLabels,
                datasets: [{
                    label: 'Cantidad',
                    data: conocisteData,
                    backgroundColor: '#198754'
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: false }
                }
            }
        });
    </script>
</body>
</html>
